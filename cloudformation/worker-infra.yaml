Description: RoboSystems Worker Infrastructure - Beat Scheduler and Worker Monitor Lambda

Parameters:
  # Environment
  Environment:
    Type: String
    Default: prod
    AllowedValues:
      - prod
      - staging
    Description: Environment name (e.g., prod, staging)
    ConstraintDescription: Must be prod or staging

  # Infrastructure & Networking Configuration
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet IDs (comma-separated)

  # Container & Application Configuration (Beat)
  ECRRepositoryUrl:
    Type: String
    Description: Full ECR repository URL (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com/robosystems)
  ECRImageTag:
    Type: String
    Description: ECR image tag
    Default: latest
    ConstraintDescription: Must be a valid Docker image tag

  # ECS & Compute Configuration (Beat)
  BeatCpu:
    Type: String
    Default: "256"
    Description: CPU units for Beat ECS task
    AllowedValues:
      - "256"
      - "512"
  BeatMemory:
    Type: String
    Default: "512"
    Description: Memory units for Beat ECS task
    AllowedValues:
      - "512"
      - "1024"
  BeatFargateSpotWeight:
    Type: Number
    Default: 80
    Description: Fargate Spot capacity provider weight for Beat
    MinValue: 0
    MaxValue: 100
  BeatFargateWeight:
    Type: Number
    Default: 20
    Description: Fargate capacity provider weight for Beat
    MinValue: 0
    MaxValue: 100

  # Lambda Configuration (Worker Monitor)
  LambdaCodeBucket:
    Type: String
    Description: S3 bucket containing Lambda deployment packages
    ConstraintDescription: Must be a valid S3 bucket name
  WorkerMonitorCodeKey:
    Type: String
    Description: S3 key for Worker Monitor Lambda deployment package
    ConstraintDescription: Must be a valid S3 object key

  # Cache Configuration (Shared)
  ValkeyUrl:
    Type: String
    Description: Valkey ElastiCache endpoint URL from Valkey stack
    AllowedPattern: ^rediss?://.*:[0-9]+$
    ConstraintDescription: Must be a valid Redis URL (redis://host:port or rediss://host:port)
  ValkeyClientSecurityGroupId:
    Type: String
    Description: Security group ID for applications connecting to Valkey
    AllowedPattern: ^sg-[0-9a-f]+$
    ConstraintDescription: Must be a valid security group ID
  ValkeyCacheClusterId:
    Type: String
    Description: ElastiCache Valkey cluster ID for Worker Monitor

  # Observability Configuration
  PrometheusStackName:
    Type: String
    Description: Name of the Prometheus CloudFormation stack for this environment
    Default: ""
    ConstraintDescription: Must be a valid CloudFormation stack name or empty

  # Logging Configuration
  LogRetentionDays:
    Type: Number
    Default: 30
    Description: CloudWatch log retention in days for Beat
  MonitorLogRetentionDays:
    Type: Number
    Default: 7
    Description: CloudWatch log retention in days for Worker Monitor

  # Tagging Configuration
  ServiceTag:
    Type: String
    Description: Service tag for resource identification and billing
    Default: RoboSystems
  BeatComponentTag:
    Type: String
    Description: Component tag for Beat resources
    Default: Beat
  MonitorComponentTag:
    Type: String
    Description: Component tag for Worker Monitor resources
    Default: WorkerMonitor

Conditions:
  HasObservabilityStack: !Not [!Equals [!Ref PrometheusStackName, ""]]
  IsProduction: !Equals [!Ref Environment, "prod"]

Resources:
  # ============================================================
  # BEAT SCHEDULER RESOURCES (ECS Fargate)
  # ============================================================

  # ECS Cluster
  BeatCluster:
    Type: AWS::ECS::Cluster
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      ClusterName: !Sub robosystems-beat-${Environment}-cluster
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref BeatComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # IAM Role for ECS Task Execution
  BeatEcsExecutionRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: ExecutionRoleSecrets
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource:
                  - !Sub "arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:robosystems/${Environment}-*"
                  - !Sub "arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:robosystems/${Environment}/*"
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Resource:
                  - !Sub "arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/secretsmanager"
                Condition:
                  StringEquals:
                    "kms:ViaService":
                      - !Sub "secretsmanager.${AWS::Region}.amazonaws.com"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref BeatComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # IAM Role for ECS Task
  BeatTaskRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BeatTaskRolePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:${AWS::Partition}:s3:::robosystems-${Environment}-deployment
                  - !Sub arn:${AWS::Partition}:s3:::robosystems-${Environment}-deployment/*
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                  - cloudwatch:DescribeAlarms
                Resource: "*"
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:DescribeTable
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/robosystems-kuzu-${Environment}-instance-registry"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/robosystems-kuzu-${Environment}-instance-registry/index/*"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/robosystems-kuzu-${Environment}-volume-registry"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/robosystems-kuzu-${Environment}-volume-registry/index/*"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/robosystems-kuzu-${Environment}-graph-registry"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/robosystems-kuzu-${Environment}-graph-registry/index/*"
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource:
                  - !Sub "arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:robosystems/${Environment}-*"
                  - !Sub "arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:robosystems/${Environment}/*"
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Resource:
                  - !Sub "arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/secretsmanager"
                  - !Sub "arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/ebs"
                  - !Sub "arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/ssm"
                Condition:
                  StringEquals:
                    "kms:ViaService":
                      - !Sub "secretsmanager.${AWS::Region}.amazonaws.com"
                      - !Sub "ec2.${AWS::Region}.amazonaws.com"
                      - !Sub "ssm.${AWS::Region}.amazonaws.com"
              - !If
                - HasObservabilityStack
                - Effect: Allow
                  Action:
                    - aps:RemoteWrite
                    - aps:QueryMetrics
                    - aps:GetLabels
                    - aps:GetSeries
                    - aps:GetMetricMetadata
                  Resource: !Sub
                    - "${PrometheusWorkspaceArn}"
                    - PrometheusWorkspaceArn:
                        Fn::ImportValue: !Sub "${PrometheusStackName}-PrometheusWorkspaceArn"
                - !Ref AWS::NoValue
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref BeatComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # Log Group
  BeatLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub /robosystems/${Environment}/beat
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref BeatComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # Security Group
  BeatSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      GroupDescription: Security group for RoboSystems Beat ECS tasks
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub sg-robosystems-beat-${Environment}
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref BeatComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # Task Definition
  BeatTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      Family: !Sub robosystems-beat-${Environment}-task
      Cpu: !Ref BeatCpu
      Memory: !Ref BeatMemory
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      ExecutionRoleArn: !GetAtt BeatEcsExecutionRole.Arn
      TaskRoleArn: !GetAtt BeatTaskRole.Arn
      ContainerDefinitions:
        - Name: beat-container
          Image: !Sub ${ECRRepositoryUrl}:${ECRImageTag}
          Essential: true
          StopTimeout: 60
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref BeatLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: beat
          Environment:
            - Name: ENVIRONMENT
              Value: !Ref Environment
            - Name: LOG_LEVEL
              Value: INFO
            - Name: DOCKER_PROFILE
              Value: beat
            - Name: RUN_MIGRATIONS
              Value: "true"
            - Name: AWS_REGION
              Value: !Ref AWS::Region
            - Name: VALKEY_URL
              Value: !Ref ValkeyUrl
            - Name: SECURITY_AUDIT_ENABLED
              Value: !If [IsProduction, "true", "false"]

  # ECS Service
  BeatService:
    Type: AWS::ECS::Service
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      ServiceName: !Sub robosystems-beat-${Environment}-service
      Cluster: !Ref BeatCluster
      DesiredCount: 1
      CapacityProviderStrategy:
        - CapacityProvider: FARGATE_SPOT
          Weight: !Ref BeatFargateSpotWeight
        - CapacityProvider: FARGATE
          Weight: !Ref BeatFargateWeight
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          Subnets: !Ref SubnetIds
          SecurityGroups:
            - !Ref BeatSecurityGroup
            - !Ref ValkeyClientSecurityGroupId
      TaskDefinition: !Ref BeatTaskDefinition
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 0
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      EnableExecuteCommand: true
      PropagateTags: SERVICE
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref BeatComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # ============================================================
  # WORKER MONITOR RESOURCES (Lambda)
  # ============================================================

  # Lambda Execution Role
  MonitorLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub robosystems-worker-monitor-${Environment}-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: WorkerMonitorPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
              - Effect: Allow
                Action:
                  - ecs:ListTasks
                  - ecs:ListServices
                  - ecs:DescribeTasks
                  - ecs:DescribeServices
                  - ecs:GetTaskProtection
                  - ecs:UpdateTaskProtection
                Resource: "*"
              - Effect: Allow
                Action:
                  - elasticache:DescribeCacheClusters
                  - elasticache:DescribeReplicationGroups
                Resource: "*"
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Sub "arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:robosystems/${Environment}/valkey-*"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref MonitorComponentTag

  # Lambda Security Group
  MonitorLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub robosystems-worker-monitor-${Environment}-sg
      GroupDescription: Security group for Worker Monitor Lambda
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub robosystems-worker-monitor-${Environment}-sg
        - Key: Environment
          Value: !Ref Environment

  # Lambda Function
  WorkerMonitorLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-worker-monitor"
      Description: Monitor worker queues and manage ECS task protection
      Runtime: python3.12
      Handler: index.handler
      Code:
        S3Bucket: !Ref LambdaCodeBucket
        S3Key: !Ref WorkerMonitorCodeKey
      MemorySize: 512
      Timeout: 120
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          VALKEY_CLUSTER_ID: !Ref ValkeyCacheClusterId
          DLQ_CRITICAL_THRESHOLD: "20"
      VpcConfig:
        SecurityGroupIds:
          - !Ref MonitorLambdaSecurityGroup
          - !Ref ValkeyClientSecurityGroupId
        SubnetIds: !Ref SubnetIds
      Role: !GetAtt MonitorLambdaExecutionRole.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref MonitorComponentTag

  # CloudWatch Log Group
  MonitorLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-worker-monitor
      RetentionInDays: !Ref MonitorLogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag

  # EventBridge Rule for scheduled execution
  MonitorScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub robosystems-worker-monitor-${Environment}-schedule
      Description: Trigger worker monitor every minute
      ScheduleExpression: rate(1 minute)
      State: ENABLED
      Targets:
        - Arn: !GetAtt WorkerMonitorLambda.Arn
          Id: WorkerMonitorTarget
          Input: |
            {
              "action": "all"
            }

  # Permission for EventBridge to invoke Lambda
  MonitorLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WorkerMonitorLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MonitorScheduleRule.Arn

  # CloudWatch Alarm for Lambda errors
  MonitorLambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub robosystems-worker-monitor-${Environment}-errors
      AlarmDescription: Alert when worker monitoring Lambda has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref WorkerMonitorLambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag

  # CloudWatch Alarm for Lambda duration
  MonitorLambdaDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub robosystems-worker-monitor-${Environment}-duration
      AlarmDescription: Alert when worker monitoring Lambda takes too long
      MetricName: Duration
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref WorkerMonitorLambda
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 30000
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag

Outputs:
  # Beat Outputs
  BeatClusterName:
    Description: Name of the Beat ECS Cluster
    Value: !Ref BeatCluster
    Export:
      Name: !Sub ${AWS::StackName}-BeatClusterName
  BeatServiceName:
    Description: Name of the Beat ECS Service
    Value: !Ref BeatService
    Export:
      Name: !Sub ${AWS::StackName}-BeatServiceName
  BeatTaskDefinitionArn:
    Description: ARN of the Beat task definition
    Value: !Ref BeatTaskDefinition
    Export:
      Name: !Sub ${AWS::StackName}-BeatTaskDefinitionArn
  BeatECRRepositoryUsed:
    Description: ECR Repository used for Beat Docker images
    Value: !Sub ${ECRRepositoryUrl}:${ECRImageTag}
    Export:
      Name: !Sub ${AWS::StackName}-BeatECRRepositoryUsed

  # Worker Monitor Outputs
  MonitorLambdaFunctionArn:
    Description: ARN of the Worker Monitor Lambda function
    Value: !GetAtt WorkerMonitorLambda.Arn
    Export:
      Name: !Sub ${AWS::StackName}-MonitorLambdaArn
  MonitorLambdaFunctionName:
    Description: Name of the Worker Monitor Lambda function
    Value: !Ref WorkerMonitorLambda
    Export:
      Name: !Sub ${AWS::StackName}-MonitorLambdaName
  MonitorScheduleRuleArn:
    Description: ARN of the EventBridge schedule rule
    Value: !GetAtt MonitorScheduleRule.Arn
    Export:
      Name: !Sub ${AWS::StackName}-MonitorScheduleRuleArn
