Description: RoboSystems Graph Database Infrastructure - DynamoDB, Lambda, and Secrets Manager

Parameters:
  # Environment
  Environment:
    Type: String
    Default: prod
    AllowedValues:
      - prod
      - staging
    Description: Environment name (prod or staging)
    ConstraintDescription: Must be prod or staging

  # Security Configuration
  EnableSecretRotation:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: Enable automatic rotation of API keys
    ConstraintDescription: Must be true or false
  RotationScheduleDays:
    Type: Number
    Default: 90
    MinValue: 1
    MaxValue: 365
    Description: Number of days between automatic API key rotations (when rotation is enabled)
    ConstraintDescription: Must be between 1 and 365 days

  # Lambda Configuration
  LambdaImageUri:
    Type: String
    Description: ECR image URI for Lambda functions (container-based deployment)

  # Monitoring & Alerting
  SNSAlertEmail:
    Type: String
    Description: Email address for infrastructure alerts
    ConstraintDescription: Must be a valid email address

  # Tagging Configuration
  ServiceTag:
    Type: String
    Default: RoboSystems
    Description: Service tag for resource identification and billing
    ConstraintDescription: Must be a valid tag value
  ComponentTag:
    Type: String
    Default: GraphInfra
    Description: Component tag for resource identification and billing
    ConstraintDescription: Must be a valid tag value

Conditions:
  EnableRotation: !Equals [!Ref EnableSecretRotation, "true"]

Resources:
  # ===== DynamoDB Tables =====
  # Single instance registry for all graph database instances (LadybugDB and Neo4j)
  InstanceRegistry:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "robosystems-graph-${Environment}-instance-registry"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: instance_id
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: database_count
          AttributeType: N
        - AttributeName: cluster_tier
          AttributeType: S
        - AttributeName: backend_type
          AttributeType: S
      KeySchema:
        - AttributeName: instance_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: status-database-count-index
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: database_count
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: tier-status-index
          KeySchema:
            - AttributeName: cluster_tier
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: backend-type-status-index
          KeySchema:
            - AttributeName: backend_type
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: RoboSystems
        - Key: Component
          Value: GraphInfra
        - Key: CreatedBy
          Value: CloudFormation

  # Single graph registry for all database allocations
  GraphRegistry:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "robosystems-graph-${Environment}-graph-registry"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: graph_id
          AttributeType: S
        - AttributeName: instance_id
          AttributeType: S
        - AttributeName: entity_id
          AttributeType: S
      KeySchema:
        - AttributeName: graph_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: instance-index
          KeySchema:
            - AttributeName: instance_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: entity-index
          KeySchema:
            - AttributeName: entity_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: RoboSystems
        - Key: Component
          Value: GraphInfra
        - Key: CreatedBy
          Value: CloudFormation

  # Volume registry for tracking graph database volumes (LadybugDB and Neo4j)
  VolumeRegistry:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "robosystems-graph-${Environment}-volume-registry"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: volume_id
          AttributeType: S
        - AttributeName: instance_id
          AttributeType: S
        - AttributeName: database_id
          AttributeType: S
        - AttributeName: tier
          AttributeType: S
      KeySchema:
        - AttributeName: volume_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: instance-index
          KeySchema:
            - AttributeName: instance_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: database-index
          KeySchema:
            - AttributeName: database_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: tier-index
          KeySchema:
            - AttributeName: tier
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Name
          Value: !Sub "robosystems-graph-${Environment}-volume-registry"
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref ComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # ===== Authentication Infrastructure =====
  # Graph API authentication secret (used by all backends on port 8001)
  GraphApiSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub robosystems/${Environment}/graph-api
      Description: !Sub Graph API authentication key for ${Environment} (used by all backends)
      SecretString: !Sub
        - |
          {
            "GRAPH_API_KEY": "${ApiKey}",
            "ENVIRONMENT": "${Environment}",
            "GENERATED_AT": "${GeneratedAt}"
          }
        - ApiKey: !GetAtt ApiKeyGenerator.ApiKey
          GeneratedAt: !GetAtt ApiKeyGenerator.GeneratedAt
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref ComponentTag
        - Key: ManagedBy
          Value: CloudFormation

  # Custom resource to generate initial API keys
  ApiKeyGenerator:
    Type: Custom::ApiKeyGenerator
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      ServiceToken: !GetAtt ApiKeyGeneratorFunction.Arn
      Environment: !Ref Environment

  ApiKeyGeneratorFunction:
    Type: AWS::Lambda::Function
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      FunctionName: !Sub "${AWS::StackName}-api-key-generator"
      Description: "API Key Generator Lambda - inline code (no S3)"
      Runtime: python3.13
      Handler: index.lambda_handler
      Role: !GetAtt ApiKeyGeneratorRole.Arn
      Timeout: 60
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-api-key-generator"
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref ComponentTag
        - Key: CreatedBy
          Value: CloudFormation
      Code:
        ZipFile: |
          """
          Graph API Key Generator Lambda Function

          CloudFormation custom resource that generates initial API keys for Graph services.
          This function is called during stack creation to generate the initial set of API keys.
          """

          import secrets
          import string
          import cfnresponse
          from datetime import datetime, timezone


          def generate_api_key(prefix, length=64):
            """
            Generate a secure API key with a given prefix.

            Args:
                prefix: Prefix for the API key (e.g., 'lbug_prod')
                length: Length of the random portion (default: 64)

            Returns:
                A secure API key string with high entropy
            """
            # Use a larger character set for better entropy
            alphabet = string.ascii_letters + string.digits + "-_"
            # Generate a longer key for better security
            random_part = "".join(secrets.choice(alphabet) for _ in range(length))
            return f"{prefix}_{random_part}"


          def lambda_handler(event, context):
            """
            CloudFormation custom resource handler for generating API keys.

            This function handles Create, Update, and Delete requests from CloudFormation.
            For Create/Update, it generates new API keys. For Delete, it simply returns success.

            Args:
                event: CloudFormation custom resource event
                context: Lambda context
            """
            try:
              request_type = event.get("RequestType", "")

              # For delete requests, just return success
              if request_type == "Delete":
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                return

              # Get the environment from the resource properties
              resource_properties = event.get("ResourceProperties", {})
              environment = resource_properties.get("Environment", "unknown")

              # Generate a single high-entropy API key
              response_data = {
                "ApiKey": generate_api_key(f"graph_{environment}"),
                "GeneratedAt": datetime.now(timezone.utc).isoformat(),
              }

              # Log the generation (without exposing the actual key)
              print(f"Generated API key for environment: {environment}")
              print(f"Request Type: {request_type}")
              print(f"Generated at: {response_data['GeneratedAt']}")

              # Send success response to CloudFormation
              cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data)

            except Exception as e:
              print(f"Error generating API keys: {str(e)}")
              error_message = str(e)

              # Send failure response to CloudFormation
              cfnresponse.send(
                event,
                context,
                cfnresponse.FAILED,
                {},
                reason=f"Failed to generate API key: {error_message}",
              )

  ApiKeyGeneratorRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Name
          Value: !Sub "robosystems-graph-${Environment}-api-key-generator-role"
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref ComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # Lambda function for secret rotation
  SecretRotationLambda:
    Type: AWS::Lambda::Function
    Condition: EnableRotation
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      FunctionName: !Sub "${AWS::StackName}-api-secret-rotation"
      Description: "Graph API Rotation Lambda - container-based deployment"
      PackageType: Image
      Architectures:
        - arm64
      Role: !GetAtt SecretRotationRole.Arn
      Timeout: 60
      MemorySize: 128
      Environment:
        Variables:
          SECRETS_MANAGER_ENDPOINT: !Sub https://secretsmanager.${AWS::Region}.amazonaws.com
      Code:
        ImageUri: !Ref LambdaImageUri
      ImageConfig:
        Command:
          - graph_api_rotation.lambda_handler
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-api-secret-rotation"
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref ComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # IAM role for rotation Lambda
  SecretRotationRole:
    Type: AWS::IAM::Role
    Condition: EnableRotation
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      RoleName: !Sub "robosystems-graph-${Environment}-secret-rotation-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SecretRotationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:DescribeSecret
                  - secretsmanager:GetSecretValue
                  - secretsmanager:PutSecretValue
                  - secretsmanager:UpdateSecretVersionStage
                Resource: !Ref GraphApiSecret
              # KMS permissions for secret rotation
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:GenerateDataKey
                Resource:
                  - !Sub "arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/secretsmanager"
                Condition:
                  StringEquals:
                    "kms:ViaService":
                      - !Sub "secretsmanager.${AWS::Region}.amazonaws.com"
              # ECR permissions for container-based Lambda
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: "*"
              - Effect: Allow
                Action:
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                Resource: !Sub "arn:${AWS::Partition}:ecr:${AWS::Region}:${AWS::AccountId}:repository/robosystems"
      Tags:
        - Key: Name
          Value: !Sub "robosystems-graph-${Environment}-secret-rotation-role"
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref ComponentTag
        - Key: CreatedBy
          Value: CloudFormation

  # Rotation schedule
  SecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Condition: EnableRotation
    DependsOn: LambdaInvokePermission
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      SecretId: !Ref GraphApiSecret
      RotationLambdaARN: !GetAtt SecretRotationLambda.Arn
      RotationRules:
        ScheduleExpression: !Sub "rate(${RotationScheduleDays} days)"
        Duration: 1h

  # Permission for Secrets Manager to invoke Lambda
  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Condition: EnableRotation
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      FunctionName: !Ref SecretRotationLambda
      Action: lambda:InvokeFunction
      Principal: secretsmanager.amazonaws.com

  # ===== Monitoring Infrastructure =====
  # SNS Topic for Infrastructure Alerts
  InfraAlertTopic:
    Type: AWS::SNS::Topic
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TopicName: !Sub robosystems-graph-${Environment}-infra-alerts
      DisplayName: !Sub "RoboSystems Graph Database ${Environment} Infrastructure Alerts"
      Tags:
        - Key: Name
          Value: !Sub "robosystems-graph-${Environment}-infra-alerts"
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: !Ref ComponentTag
        - Key: CreatedBy
          Value: CloudFormation
      Subscription:
        - Endpoint: !Ref SNSAlertEmail
          Protocol: email

  # Database capacity alarms
  DatabaseCapacityAlarm:
    Type: AWS::CloudWatch::Alarm
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      AlarmName: !Sub robosystems-graph-${Environment}-database-capacity
      AlarmDescription: RoboSystems graph database capacity is running low
      MetricName: DatabaseUtilizationPercent
      Namespace: RoboSystems/Graph
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 85
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: Environment
          Value: !Ref Environment
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref InfraAlertTopic

  # ===== CloudWatch Log Groups =====
  # Unified log group for ALL Graph API instances (LadybugDB and Neo4j backends)
  # Log streams are partitioned by: {cluster_tier}/{instance_id}/{node_type}
  # Examples:
  #   - standard/i-1234567890abcdef0/writer
  #   - large/i-0987654321fedcba0/writer
  #   - shared/i-abcdef1234567890/shared_master
  #   - neo4j-community-large/i-fedcba0987654321/writer
  GraphUnifiedLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub "/robosystems/${Environment}/graph-api"
      RetentionInDays: 30
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: !Ref ServiceTag
        - Key: Component
          Value: GraphAPI
        - Key: Description
          Value: "Unified log group for all Graph API instances"

Outputs:
  # CloudWatch Log Groups
  GraphUnifiedLogGroupName:
    Description: Unified CloudWatch log group for all Graph API instances
    Value: !Ref GraphUnifiedLogGroup
    Export:
      Name: !Sub "${AWS::StackName}-unified-log-group"

  # DynamoDB Table Names
  InstanceRegistryTableName:
    Description: DynamoDB table name for instance registry
    Value: !Ref InstanceRegistry
    Export:
      Name: !Sub "${AWS::StackName}-InstanceRegistryTable"

  GraphRegistryTableName:
    Description: DynamoDB table name for graph registry
    Value: !Ref GraphRegistry
    Export:
      Name: !Sub "${AWS::StackName}-GraphRegistryTable"

  # DynamoDB Table ARNs
  InstanceRegistryTableArn:
    Description: DynamoDB table ARN for instance registry
    Value: !GetAtt InstanceRegistry.Arn
    Export:
      Name: !Sub "${AWS::StackName}-InstanceRegistryTableArn"

  GraphRegistryTableArn:
    Description: DynamoDB table ARN for graph registry
    Value: !GetAtt GraphRegistry.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GraphRegistryTableArn"

  VolumeRegistryTableName:
    Description: DynamoDB table name for volume registry
    Value: !Ref VolumeRegistry
    Export:
      Name: !Sub "${AWS::StackName}-VolumeRegistryTable"

  VolumeRegistryTableArn:
    Description: DynamoDB table ARN for volume registry
    Value: !GetAtt VolumeRegistry.Arn
    Export:
      Name: !Sub "${AWS::StackName}-VolumeRegistryTableArn"

  # Authentication
  SecretArn:
    Description: ARN of the Graph API authentication secret
    Value: !Ref GraphApiSecret
    Export:
      Name: !Sub "${AWS::StackName}-SecretArn"

  # Monitoring
  AlertTopicArn:
    Description: SNS topic ARN for infrastructure alerts
    Value: !Ref InfraAlertTopic
    Export:
      Name: !Sub "${AWS::StackName}-AlertTopicArn"
