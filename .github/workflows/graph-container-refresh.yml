name: Graph Container Refresh

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to update (staging, prod)"
        required: true
        type: choice
        options:
          - staging
          - prod
      node_types:
        description: "Node types to update: 'all' (everything), 'writer' (all writers including shared), or 'shared' (only shared writer)"
        required: false
        type: choice
        options:
          - all
          - writer
          - shared
        default: "all"
      rolling_update:
        description: "Perform rolling updates"
        required: false
        type: boolean
        default: true
      health_check_timeout:
        description: "Health check timeout in seconds"
        required: false
        type: string
        default: "30"
  workflow_call:
    inputs:
      environment:
        description: "Environment to update (staging, prod)"
        required: true
        type: string
      runner_config:
        description: "GitHub Actions runner configuration (JSON array)"
        required: false
        type: string
        default: '["ubuntu-latest"]'
      aws_account_id:
        description: "AWS Account ID"
        required: true
        type: string
      aws_region:
        description: "AWS region"
        required: false
        type: string
        default: "us-east-1"
      node_types:
        description: "Node types to update ('writer' includes both standard and shared writers, 'all' updates everything)"
        required: false
        type: string
        default: "all"
      rolling_update:
        description: "Whether to perform rolling updates"
        required: false
        type: string
        default: "true"
      health_check_timeout:
        description: "Seconds to wait for health check"
        required: false
        type: string
        default: "30"
    outputs:
      instances_updated:
        description: "Number of instances updated"
        value: ${{ jobs.summary.outputs.instances_updated }}
    secrets:
      ACTIONS_TOKEN:
        required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  check-runner-availability:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      runner_config: ${{ steps.check.outputs.runner_config }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Check runner availability
        id: check
        uses: ./.github/actions/runner-availability
        with:
          runner_labels: ${{ vars.RUNNER_LABELS || 'github-hosted' }}
          runner_scope: ${{ vars.RUNNER_SCOPE || 'both' }}
          github_token: ${{ secrets.ACTIONS_TOKEN || github.token }}

  collect-instances:
    needs: [check-runner-availability]
    if: always() && (needs.check-runner-availability.result == 'success' || needs.check-runner-availability.result == 'skipped')
    runs-on: ${{ github.event_name == 'workflow_dispatch' && fromJSON(needs.check-runner-availability.outputs.runner_config) || fromJSON(inputs.runner_config) }}
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
      has_instances: ${{ steps.collect.outputs.has_instances }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event_name == 'workflow_dispatch' && (vars.AWS_REGION || 'us-east-1') || inputs.aws_region }}

      - name: Collect instances to update
        id: collect
        run: |
          echo "üîç Collecting graph database instances for environment: ${{ inputs.environment }}"

          NODE_TYPES="${{ inputs.node_types }}"
          INSTANCES_JSON="[]"

          # Check what to update based on node_types input
          if [ "$NODE_TYPES" == "all" ] || [ "$NODE_TYPES" == "writer" ] || [ "$NODE_TYPES" == "shared" ]; then
            echo "üì¶ Collecting writer instances..."

            # Get all graph writers (LadybugDB backend - using LadybugRole tag)
            LBUG_WRITERS=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Environment,Values=${{ inputs.environment }}" \
                "Name=tag:LadybugRole,Values=writer" \
                "Name=instance-state-name,Values=running" \
              --query "Reservations[].Instances[].InstanceId" \
              --output text \
              --region "${{ github.event_name == 'workflow_dispatch' && (vars.AWS_REGION || 'us-east-1') || inputs.aws_region }}" 2>/dev/null || echo "")

            # Get all Neo4j writers (using GraphRole tag)
            NEO4J_WRITERS=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Environment,Values=${{ inputs.environment }}" \
                "Name=tag:GraphRole,Values=writer" \
                "Name=tag:GraphBackend,Values=neo4j" \
                "Name=instance-state-name,Values=running" \
              --query "Reservations[].Instances[].InstanceId" \
              --output text \
              --region "${{ github.event_name == 'workflow_dispatch' && (vars.AWS_REGION || 'us-east-1') || inputs.aws_region }}" 2>/dev/null || echo "")

            # Process graph writers (LadybugDB backend)
            for INSTANCE in $LBUG_WRITERS; do
              TIER=$(aws ec2 describe-tags \
                --filters \
                  "Name=resource-id,Values=$INSTANCE" \
                  "Name=key,Values=WriterTier" \
                --query "Tags[0].Value" \
                --output text \
                --region "${{ github.event_name == 'workflow_dispatch' && (vars.AWS_REGION || 'us-east-1') || inputs.aws_region }}" 2>/dev/null || echo "")

              # Filter instances based on node_types parameter
              if [ "$NODE_TYPES" == "shared" ]; then
                if [ "$TIER" != "shared" ]; then
                  continue
                fi
              elif [ "$NODE_TYPES" == "writer" ] || [ "$NODE_TYPES" == "all" ]; then
                true
              fi

              # Determine node type based on tier
              if [ "$TIER" == "shared" ]; then
                NODE_TYPE="shared-writer"
                echo "  Found graph shared writer (LadybugDB): $INSTANCE"
              else
                NODE_TYPE="writer"
                echo "  Found graph writer (LadybugDB): $INSTANCE (tier: ${TIER:-standard})"
              fi

              INSTANCE_OBJ="{\"instance_id\":\"$INSTANCE\",\"node_type\":\"$NODE_TYPE\",\"backend\":\"ladybug\"}"
              if [ "$INSTANCES_JSON" == "[]" ]; then
                INSTANCES_JSON="[$INSTANCE_OBJ]"
              else
                INSTANCES_JSON="${INSTANCES_JSON%]},${INSTANCE_OBJ}]"
              fi
            done

            # Process Neo4j writers
            for INSTANCE in $NEO4J_WRITERS; do
              TIER=$(aws ec2 describe-tags \
                --filters \
                  "Name=resource-id,Values=$INSTANCE" \
                  "Name=key,Values=WriterTier" \
                --query "Tags[0].Value" \
                --output text \
                --region "${{ github.event_name == 'workflow_dispatch' && (vars.AWS_REGION || 'us-east-1') || inputs.aws_region }}" 2>/dev/null || echo "")

              # Filter instances based on node_types parameter
              if [ "$NODE_TYPES" == "shared" ]; then
                if [ "$TIER" != "shared" ]; then
                  continue
                fi
              elif [ "$NODE_TYPES" == "writer" ] || [ "$NODE_TYPES" == "all" ]; then
                true
              fi

              # Determine node type
              if [ "$TIER" == "shared" ]; then
                NODE_TYPE="shared-writer"
                echo "  Found Neo4j shared writer: $INSTANCE"
              else
                NODE_TYPE="writer"
                echo "  Found Neo4j writer: $INSTANCE (tier: ${TIER:-standard})"
              fi

              INSTANCE_OBJ="{\"instance_id\":\"$INSTANCE\",\"node_type\":\"$NODE_TYPE\",\"backend\":\"neo4j\"}"
              if [ "$INSTANCES_JSON" == "[]" ]; then
                INSTANCES_JSON="[$INSTANCE_OBJ]"
              else
                INSTANCES_JSON="${INSTANCES_JSON%]},${INSTANCE_OBJ}]"
              fi
            done
          fi

          echo "instances_json=$INSTANCES_JSON"

          if [ "$INSTANCES_JSON" == "[]" ]; then
            echo "‚ÑπÔ∏è No instances found to update"
            echo "matrix={}" >> $GITHUB_OUTPUT
            echo "has_instances=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found instances to update"
            echo "matrix={\"include\":$INSTANCES_JSON}" >> $GITHUB_OUTPUT
            echo "has_instances=true" >> $GITHUB_OUTPUT

            # Display what will be updated
            echo "üìã Instances to update:"
            echo "$INSTANCES_JSON" | jq -r '.[] | "  - \(.instance_id) (\(.backend)/\(.node_type))"'
          fi

  update-containers:
    needs: [check-runner-availability, collect-instances]
    if: |
      always() &&
      needs.collect-instances.outputs.has_instances == 'true' &&
      (needs.check-runner-availability.result == 'success' || needs.check-runner-availability.result == 'skipped')
    runs-on: ${{ github.event_name == 'workflow_dispatch' && fromJSON(needs.check-runner-availability.outputs.runner_config) || fromJSON(inputs.runner_config) }}
    timeout-minutes: 15
    strategy:
      matrix: ${{ fromJSON(needs.collect-instances.outputs.matrix) }}
      max-parallel: 10
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event_name == 'workflow_dispatch' && (vars.AWS_REGION || 'us-east-1') || inputs.aws_region }}

      - name: Get AWS Account ID
        id: aws-account
        if: github.event_name == 'workflow_dispatch'
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${ACCOUNT_ID}" >> $GITHUB_OUTPUT

      - name: Update Container
        uses: ./.github/actions/refresh-graph-containers
        with:
          environment: ${{ inputs.environment }}
          instance-id: ${{ matrix.instance_id }}
          node-type: ${{ matrix.node_type }}
          backend: ${{ matrix.backend }}
          aws-region: ${{ github.event_name == 'workflow_dispatch' && (vars.AWS_REGION || 'us-east-1') || inputs.aws_region }}
          aws-account-id: ${{ github.event_name == 'workflow_dispatch' && steps.aws-account.outputs.account_id || inputs.aws_account_id }}
          health-check-timeout: ${{ inputs.health_check_timeout }}

  summary:
    needs: [collect-instances, update-containers]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      instances_updated: ${{ steps.count.outputs.total }}
    steps:
      - name: Count updated instances
        id: count
        run: |
          if [ "${{ needs.collect-instances.outputs.has_instances }}" == "true" ]; then
            TOTAL=$(echo '${{ needs.collect-instances.outputs.matrix }}' | jq '.include | length')
            echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate Summary
        run: |
          echo "### üéØ Graph Container Refresh Summary"
          echo ""

          if [ "${{ needs.collect-instances.outputs.has_instances }}" != "true" ]; then
            echo "‚ÑπÔ∏è No instances found to update"
          else
            echo "| Instance | Backend | Status |"
            echo "|----------|---------|--------|"

            echo '${{ needs.collect-instances.outputs.matrix }}' | jq -r '.include[] | "| \(.instance_id) (\(.node_type)) | \(.backend) | ‚è≥ |"'
          fi

          echo ""
          echo "**Environment:** ${{ inputs.environment }}"
          echo "**Node Types:** ${{ inputs.node_types }}"
          echo "**Parallel Updates:** Yes (max 10)"
          echo "**Trigger:** ${{ github.event_name }}"
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)"
