name: Deploy Production

permissions:
  contents: read
  deployments: write
  id-token: write

concurrency:
  group: robosystems-deploy-prod
  cancel-in-progress: false

on:
  workflow_dispatch: {}

jobs:
  runner:
    runs-on: ubuntu-latest
    outputs:
      runners_available: ${{ steps.check.outputs.runners_available }}
      runner_type: ${{ steps.check.outputs.runner_type }}
      runner_config: ${{ steps.check.outputs.runner_config }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Check runner availability
        id: check
        uses: ./.github/actions/runner-availability
        with:
          runner_labels: ${{ vars.RUNNER_LABELS || 'github-hosted' }}
          runner_scope: ${{ vars.RUNNER_SCOPE || 'both' }}
          github_token: ${{ secrets.ACTIONS_TOKEN }}

  stack-config:
    needs: [runner]
    runs-on: ${{ fromJSON(needs.runner.outputs.runner_config) }}
    outputs:
      vpc_stack: ${{ steps.load.outputs.vpc_stack }}
      s3_stack: ${{ steps.load.outputs.s3_stack }}
      postgres_stack: ${{ steps.load.outputs.postgres_stack }}
      valkey_stack: ${{ steps.load.outputs.valkey_stack }}
      api_stack: ${{ steps.load.outputs.api_stack }}
      graph_infra_stack: ${{ steps.load.outputs.graph_infra_stack }}
      graph_volumes_stack: ${{ steps.load.outputs.graph_volumes_stack }}
      prometheus_stack: ${{ steps.load.outputs.prometheus_stack }}
      grafana_stack: ${{ steps.load.outputs.grafana_stack }}
      bastion_stack: ${{ steps.load.outputs.bastion_stack }}
      waf_stack: ${{ steps.load.outputs.waf_stack }}
      cloudtrail_stack: ${{ steps.load.outputs.cloudtrail_stack }}
      dagster_stack: ${{ steps.load.outputs.dagster_stack }}
      domain_name_root: ${{ steps.config.outputs.domain_name_root }}
      jwt_issuer: ${{ steps.config.outputs.jwt_issuer }}
      jwt_audience: ${{ steps.config.outputs.jwt_audience }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Install PyYAML
        run: pip install --user pyyaml

      - name: Load Stack Configuration
        id: load
        shell: bash
        run: |
          chmod +x bin/tools/stack-config.sh

          ENV="production"

          # Load all stack names from config
          echo "vpc_stack=$(./bin/tools/stack-config.sh $ENV vpc)" >> $GITHUB_OUTPUT
          echo "s3_stack=$(./bin/tools/stack-config.sh $ENV s3)" >> $GITHUB_OUTPUT
          echo "postgres_stack=$(./bin/tools/stack-config.sh $ENV postgres)" >> $GITHUB_OUTPUT
          echo "valkey_stack=$(./bin/tools/stack-config.sh $ENV valkey)" >> $GITHUB_OUTPUT
          echo "api_stack=$(./bin/tools/stack-config.sh $ENV api)" >> $GITHUB_OUTPUT
          echo "graph_infra_stack=$(./bin/tools/stack-config.sh $ENV graph.infra)" >> $GITHUB_OUTPUT
          echo "graph_volumes_stack=$(./bin/tools/stack-config.sh $ENV graph.volumes)" >> $GITHUB_OUTPUT
          echo "prometheus_stack=$(./bin/tools/stack-config.sh $ENV monitoring.prometheus)" >> $GITHUB_OUTPUT
          echo "grafana_stack=$(./bin/tools/stack-config.sh $ENV monitoring.grafana)" >> $GITHUB_OUTPUT
          echo "bastion_stack=$(./bin/tools/stack-config.sh $ENV bastion)" >> $GITHUB_OUTPUT
          echo "waf_stack=$(./bin/tools/stack-config.sh $ENV waf)" >> $GITHUB_OUTPUT
          echo "cloudtrail_stack=$(./bin/tools/stack-config.sh $ENV cloudtrail)" >> $GITHUB_OUTPUT
          echo "dagster_stack=$(./bin/tools/stack-config.sh $ENV dagster)" >> $GITHUB_OUTPUT

      - name: Set Environment Configuration
        id: config
        shell: bash
        run: |
          # Domain and JWT configuration for prod
          echo "domain_name_root=${{ vars.API_DOMAIN_NAME_ROOT || 'robosystems.ai' }}" >> $GITHUB_OUTPUT

          # Strip https:// prefix from JWT issuer and audience URLs
          JWT_ISSUER="${{ vars.ROBOSYSTEMS_API_URL_PROD || '' }}"
          JWT_ISSUER="${JWT_ISSUER#https://}"
          JWT_ISSUER="${JWT_ISSUER#http://}"
          echo "jwt_issuer=$JWT_ISSUER" >> $GITHUB_OUTPUT

          JWT_AUD1="${{ vars.ROBOSYSTEMS_APP_URL_PROD || '' }}"
          JWT_AUD1="${JWT_AUD1#https://}"
          JWT_AUD1="${JWT_AUD1#http://}"

          JWT_AUD2="${{ vars.ROBOLEDGER_APP_URL_PROD || '' }}"
          JWT_AUD2="${JWT_AUD2#https://}"
          JWT_AUD2="${JWT_AUD2#http://}"

          JWT_AUD3="${{ vars.ROBOINVESTOR_APP_URL_PROD || '' }}"
          JWT_AUD3="${JWT_AUD3#https://}"
          JWT_AUD3="${JWT_AUD3#http://}"

          echo "jwt_audience=$JWT_AUD1,$JWT_AUD2,$JWT_AUD3" >> $GITHUB_OUTPUT

  test:
    needs: [runner]
    uses: ./.github/workflows/test.yml
    with:
      runner_config: ${{ needs.runner.outputs.runner_config }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}

  build:
    needs: [runner]
    uses: ./.github/workflows/build.yml
    with:
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      ecr_repository: ${{ vars.ECR_REPOSITORY || 'robosystems' }}
      # Docker Hub publishing: only when explicitly enabled AND deploying from a version tag or release branch
      # Set DOCKERHUB_PUBLISHING_ENABLED to 'true' in GitHub variables when ready to publish
      # Supports: refs/tags/v*.*.* (releases) and refs/heads/release/* (hotfixes)
      publish_to_dockerhub: ${{ vars.DOCKERHUB_PUBLISHING_ENABLED == 'true' && (startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/heads/release/')) }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  create-deployment:
    needs: [runner, test, build, stack-config]
    runs-on: ${{ fromJSON(needs.runner.outputs.runner_config) }}
    outputs:
      deployment_id: ${{ steps.deployment.outputs.deployment_id }}
    steps:
      - name: Create GitHub Deployment
        id: deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}
          environment: production
          description: "Production Deployment Created"
      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}
          state: in_progress
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          description: "Production Deployment In Progress"

  deploy-vpc:
    needs: [runner, create-deployment, stack-config]
    uses: ./.github/workflows/deploy-vpc.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.vpc_stack }}
      cloudtrail_stack_name: ${{ needs.stack-config.outputs.cloudtrail_stack }}
      environment: shared
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      # VPC Configuration
      max_availability_zones: ${{ vars.MAX_AVAILABILITY_ZONES || '5' }}
      # VPC Flow Logs Configuration (VPC-level, not environment-specific)
      vpc_flow_logs_enabled: ${{ vars.VPC_FLOW_LOGS_ENABLED || 'true' }}
      vpc_flow_logs_retention_days: ${{ vars.VPC_FLOW_LOGS_RETENTION_DAYS || '30' }}
      vpc_flow_logs_traffic_type: ${{ vars.VPC_FLOW_LOGS_TRAFFIC_TYPE || 'REJECT' }}
      # CloudTrail Configuration (account-level, not environment-specific)
      cloudtrail_enabled: ${{ vars.CLOUDTRAIL_ENABLED || 'true' }}
      cloudtrail_log_retention_days: ${{ vars.CLOUDTRAIL_LOG_RETENTION_DAYS || '90' }}
      cloudtrail_data_events_enabled: ${{ vars.CLOUDTRAIL_DATA_EVENTS_ENABLED || 'false' }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-s3:
    needs: [runner, create-deployment, stack-config]
    uses: ./.github/workflows/deploy-s3.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.s3_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      # Domain Configuration
      public_domain_name: ${{ vars.PUBLIC_DOMAIN_NAME_PROD || 'public.robosystems.ai' }}
      domain_name_root: ${{ vars.API_DOMAIN_NAME_ROOT || 'robosystems.ai' }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  package-scripts:
    needs: [runner, deploy-s3]
    runs-on: ${{ fromJSON(needs.runner.outputs.runner_config) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Package and upload scripts
        run: |
          echo "ðŸ“¦ Packaging UserData scripts and CloudFormation templates..."
          ./bin/tools/package-scripts.sh ${{ vars.ENVIRONMENT_PROD || 'prod' }}
          echo "âœ… Scripts packaged and uploaded successfully"

  deploy-postgres:
    needs: [runner, create-deployment, stack-config, build, deploy-vpc]
    uses: ./.github/workflows/deploy-postgres.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.postgres_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      vpc_id: ${{ needs.deploy-vpc.outputs.vpc_id }}
      subnet_ids: ${{ needs.deploy-vpc.outputs.private_subnet_ids }}
      # Database Engine Configuration
      engine: ${{ vars.DATABASE_ENGINE_PROD || 'postgres' }}
      # Instance Configuration
      instance_size: ${{ vars.DATABASE_INSTANCE_SIZE_PROD || 'db.t4g.small' }}
      allocated_storage: ${{ vars.DATABASE_ALLOCATED_STORAGE_PROD || '20' }}
      allocated_max_storage: ${{ vars.DATABASE_MAX_ALLOCATED_STORAGE_PROD || '100' }}
      # High Availability Configuration
      multi_az_enabled: ${{ vars.DATABASE_MULTI_AZ_ENABLED_PROD || 'false' }}
      # Secret Rotation Configuration
      secrets_rotation_days: ${{ vars.DATABASE_SECRETS_ROTATION_DAYS || '90' }}
      # Lambda Configuration (container-based)
      lambda_image_uri: ${{ needs.build.outputs.lambda_image }}
      # Other Configuration
      aws_sns_alert_email: ${{ vars.AWS_SNS_ALERT_EMAIL }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-valkey:
    needs: [runner, create-deployment, stack-config, build, deploy-vpc]
    uses: ./.github/workflows/deploy-valkey.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.valkey_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      vpc_id: ${{ needs.deploy-vpc.outputs.vpc_id }}
      subnet_ids: ${{ needs.deploy-vpc.outputs.private_subnet_ids }}
      # Instance Configuration
      node_type: ${{ vars.VALKEY_NODE_TYPE_PROD || 'cache.m6g.large' }}
      num_cache_nodes: ${{ vars.VALKEY_NUM_NODES_PROD || '1' }}
      # Security Configuration
      encryption_enabled: ${{ vars.VALKEY_ENCRYPTION_ENABLED_PROD || 'true' }}
      secret_rotation_enabled: ${{ vars.VALKEY_SECRET_ROTATION_ENABLED_PROD || 'true' }}
      rotation_schedule_days: ${{ vars.VALKEY_ROTATION_SCHEDULE_DAYS_PROD || '90' }}
      # Backup Configuration
      snapshot_retention_days: ${{ vars.VALKEY_SNAPSHOT_RETENTION_DAYS_PROD || '7' }}
      # Lambda Configuration (container-based)
      lambda_image_uri: ${{ needs.build.outputs.lambda_image }}
      # Other Configuration
      aws_sns_alert_email: ${{ vars.AWS_SNS_ALERT_EMAIL }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-prometheus:
    if: vars.OBSERVABILITY_ENABLED_PROD != 'false'
    needs: [runner, create-deployment, stack-config, deploy-vpc]
    uses: ./.github/workflows/deploy-prometheus.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.prometheus_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-grafana:
    if: vars.OBSERVABILITY_ENABLED_PROD != 'false'
    needs: [runner, create-deployment, stack-config]
    uses: ./.github/workflows/deploy-grafana.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.grafana_stack }}
      environment: shared
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-bastion:
    needs:
      [
        runner,
        create-deployment,
        stack-config,
        deploy-vpc,
        deploy-postgres,
        deploy-valkey,
      ]
    uses: ./.github/workflows/deploy-bastion.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.bastion_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      vpc_id: ${{ needs.deploy-vpc.outputs.vpc_id }}
      public_subnet_ids: ${{ needs.deploy-vpc.outputs.public_subnet_ids }}
      bastion_allowed_cidr: ${{ vars.BASTION_ALLOWED_CIDR }}
      bastion_key_pair_name: ${{ vars.BASTION_KEY_PAIR_NAME }}
      # Security Groups
      valkey_sg_id: ${{ needs.deploy-valkey.outputs.valkey_sg_id }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Graph Infrastructure - Step 1: Deploy DynamoDB, Secrets, Lambda monitoring
  deploy-graph-infra:
    needs:
      [runner, create-deployment, stack-config, build, deploy-vpc, deploy-s3]
    uses: ./.github/workflows/deploy-graph-infra.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.graph_infra_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      # Alert Configuration
      rotation_schedule_days: ${{ vars.GRAPH_API_KEY_ROTATION_DAYS || '90' }}
      # Lambda Configuration (container-based)
      lambda_image_uri: ${{ needs.build.outputs.lambda_image }}
      # Other Configuration
      aws_sns_alert_email: ${{ vars.AWS_SNS_ALERT_EMAIL }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Graph Infrastructure - Step 2: Deploy EBS volume management
  deploy-graph-volumes:
    needs: [runner, stack-config, build, deploy-vpc, deploy-graph-infra]
    uses: ./.github/workflows/deploy-graph-volumes.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.graph_volumes_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      vpc_id: ${{ needs.deploy-vpc.outputs.vpc_id }}
      subnet_ids: ${{ needs.deploy-vpc.outputs.private_subnet_ids }}
      # Registry Configuration
      volume_registry_table: ${{ needs.deploy-graph-infra.outputs.volume_registry_table }}
      # Lambda Configuration (container-based)
      lambda_image_uri: ${{ needs.build.outputs.lambda_image }}
      # Secrets Configuration
      graph_api_secret_arn: ${{ needs.deploy-graph-infra.outputs.secret_arn }}
      # Other Configuration
      aws_sns_alert_email: ${{ vars.AWS_SNS_ALERT_EMAIL }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-graph:
    needs:
      [
        runner,
        create-deployment,
        build,
        deploy-vpc,
        deploy-postgres,
        deploy-valkey,
        deploy-s3,
        deploy-graph-infra,
        deploy-graph-volumes,
      ]
    uses: ./.github/workflows/deploy-graph.yml
    with:
      # Environment Configuration
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_account_id: ${{ vars.AWS_ACCOUNT_ID }}
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      vpc_id: ${{ needs.deploy-vpc.outputs.vpc_id }}
      subnet_ids: ${{ needs.deploy-vpc.outputs.private_subnet_ids }}
      public_subnet_ids: ${{ needs.deploy-vpc.outputs.public_subnet_ids }}
      valkey_sg_id: ${{ needs.deploy-valkey.outputs.valkey_sg_id }}
      ami_id: ${{ vars.GRAPH_AMI_ID_PROD }}
      # Container Configuration
      ecr_image_tag: latest
      # Infrastructure inputs from graph infrastructure jobs
      secret_arn: ${{ needs.deploy-graph-infra.outputs.secret_arn }}
      volume_registry_table: ${{ needs.deploy-graph-infra.outputs.volume_registry_table }}
      volume_manager_function_arn: ${{ needs.deploy-graph-volumes.outputs.volume_manager_function_arn }}
      volume_detachment_topic_arn: ${{ needs.deploy-graph-volumes.outputs.volume_detachment_topic_arn }}
      # Graph Tier Configuration
      lbug_large_enabled: ${{ vars.LBUG_LARGE_ENABLED_PROD }}
      lbug_xlarge_enabled: ${{ vars.LBUG_XLARGE_ENABLED_PROD }}
      # Graph Scaling Configuration
      lbug_standard_min_instances: ${{ vars.LBUG_STANDARD_MIN_INSTANCES_PROD }}
      lbug_standard_max_instances: ${{ vars.LBUG_STANDARD_MAX_INSTANCES_PROD }}
      lbug_large_min_instances: ${{ vars.LBUG_LARGE_MIN_INSTANCES_PROD }}
      lbug_large_max_instances: ${{ vars.LBUG_LARGE_MAX_INSTANCES_PROD }}
      lbug_xlarge_min_instances: ${{ vars.LBUG_XLARGE_MIN_INSTANCES_PROD }}
      lbug_xlarge_max_instances: ${{ vars.LBUG_XLARGE_MAX_INSTANCES_PROD }}
      lbug_shared_min_instances: ${{ vars.LBUG_SHARED_MIN_INSTANCES_PROD }}
      lbug_shared_max_instances: ${{ vars.LBUG_SHARED_MAX_INSTANCES_PROD }}
      # Other Configuration
      aws_sns_alert_email: ${{ vars.AWS_SNS_ALERT_EMAIL }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  graph-container-refresh:
    needs: [runner, create-deployment, build, deploy-graph]
    if: ${{ vars.GRAPH_UPDATE_CONTAINERS_PROD == 'true' }}
    uses: ./.github/workflows/graph-container-refresh.yml
    with:
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      runner_config: ${{ needs.runner.outputs.runner_config }}
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      aws_account_id: ${{ vars.AWS_ACCOUNT_ID }}
      node_types: writer
      rolling_update: "true"
      health_check_timeout: "30"
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-api:
    needs:
      [
        runner,
        create-deployment,
        stack-config,
        build,
        deploy-vpc,
        deploy-graph,
        deploy-valkey,
        deploy-postgres,
        deploy-s3,
        deploy-grafana,
        deploy-prometheus,
      ]
    if: ${{ !cancelled() && !contains(needs.*.result, 'cancelled') && !contains(needs.*.result, 'failure') }}
    uses: ./.github/workflows/deploy-api.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.api_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      vpc_id: ${{ needs.deploy-vpc.outputs.vpc_id }}
      subnet_ids: ${{ needs.deploy-vpc.outputs.private_subnet_ids }}
      public_subnet_ids: ${{ needs.deploy-vpc.outputs.public_subnet_ids }}
      # Container & Application Configuration
      ecr_repository_url: ${{ needs.build.outputs.ecr_repository_url }}
      ecr_image_tag: latest
      # ECS & Compute Configuration
      desired_count: ${{ vars.API_MIN_CAPACITY_PROD || '1' }}
      cpu: "512"
      memory: "1024"
      fargate_weight: "1"
      fargate_spot_weight: "99"
      # Auto-scaling Configuration
      min_capacity: ${{ vars.API_MIN_CAPACITY_PROD || '1' }}
      max_capacity: ${{ vars.API_MAX_CAPACITY_PROD || '2' }}
      cpu_target_value: "70"
      memory_target_value: "80"
      # Domain & DNS Configuration
      domain_name: ${{ vars.API_DOMAIN_NAME_PROD }}
      domain_name_root: ${{ needs.stack-config.outputs.domain_name_root }}
      # JWT Configuration
      jwt_issuer: ${{ needs.stack-config.outputs.jwt_issuer }}
      jwt_audience: ${{ needs.stack-config.outputs.jwt_audience }}
      # Cache Configuration
      valkey_url: ${{ needs.deploy-valkey.outputs.valkey_url }}
      valkey_sg_id: ${{ needs.deploy-valkey.outputs.valkey_sg_id }}
      admin_allowed_cidrs: ${{ vars.ADMIN_ALLOWED_CIDRS }}
      # WAF Configuration (environment-specific)
      waf_enabled: ${{ vars.WAF_ENABLED_PROD || 'true' }}
      waf_stack_name: ${{ needs.stack-config.outputs.waf_stack }}
      waf_rate_limit_per_ip: ${{ vars.WAF_RATE_LIMIT_PER_IP || '10000' }}
      waf_enable_geo_blocking: ${{ vars.WAF_GEO_BLOCKING_ENABLED || 'false' }}
      waf_enable_aws_managed_rules: ${{ vars.WAF_AWS_MANAGED_RULES_ENABLED || 'true' }}
      # Other Configuration
      prometheus_stack_name: ${{ needs.deploy-prometheus.outputs.prometheus_stack_name || '' }}
      aws_sns_alert_email: ${{ vars.AWS_SNS_ALERT_EMAIL }}
      refresh_ecs_service: ${{ vars.API_ASG_REFRESH_PROD || 'false' }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-dagster:
    needs:
      [
        runner,
        create-deployment,
        stack-config,
        build,
        deploy-vpc,
        deploy-graph,
        deploy-valkey,
        deploy-postgres,
        deploy-s3,
        deploy-grafana,
        deploy-prometheus,
        deploy-bastion,
      ]
    if: ${{ !cancelled() && !contains(needs.*.result, 'cancelled') && !contains(needs.*.result, 'failure') }}
    uses: ./.github/workflows/deploy-dagster.yml
    with:
      # Stack & Repository Configuration
      stack_name: ${{ needs.stack-config.outputs.dagster_stack }}
      environment: ${{ vars.ENVIRONMENT_PROD || 'prod' }}
      # GHA Runner Configuration
      runner_config: ${{ needs.runner.outputs.runner_config }}
      # AWS Configuration
      aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
      vpc_id: ${{ needs.deploy-vpc.outputs.vpc_id }}
      subnet_ids: ${{ needs.deploy-vpc.outputs.private_subnet_ids }}
      # Container & Application Configuration
      ecr_repository_url: ${{ needs.build.outputs.ecr_repository_url }}
      ecr_image_tag: latest
      # Fargate Configuration
      daemon_cpu: ${{ vars.DAGSTER_DAEMON_CPU_PROD || '512' }}
      daemon_memory: ${{ vars.DAGSTER_DAEMON_MEMORY_PROD || '1024' }}
      webserver_cpu: ${{ vars.DAGSTER_WEBSERVER_CPU_PROD || '512' }}
      webserver_memory: ${{ vars.DAGSTER_WEBSERVER_MEMORY_PROD || '1024' }}
      webserver_desired_count: ${{ vars.DAGSTER_WEBSERVER_DESIRED_COUNT_PROD || '1' }}
      webserver_min_capacity: ${{ vars.DAGSTER_WEBSERVER_MIN_CAPACITY_PROD || '1' }}
      webserver_max_capacity: ${{ vars.DAGSTER_WEBSERVER_MAX_CAPACITY_PROD || '3' }}
      # Run Job Configuration (for EcsRunLauncher)
      run_job_cpu: ${{ vars.DAGSTER_RUN_JOB_CPU_PROD || '1024' }}
      run_job_memory: ${{ vars.DAGSTER_RUN_JOB_MEMORY_PROD || '4096' }}
      # Cache Configuration
      valkey_url: ${{ needs.deploy-valkey.outputs.valkey_url }}
      valkey_sg_id: ${{ needs.deploy-valkey.outputs.valkey_sg_id }}
      # Database Configuration
      database_sg_id: ${{ needs.deploy-postgres.outputs.database_sg_id }}
      # Bastion Access (for internal UI access)
      bastion_sg_id: ${{ needs.deploy-bastion.outputs.bastion_sg_id }}
      # Other Configuration
      refresh_ecs_service: ${{ vars.DAGSTER_REFRESH_ECS_PROD || 'false' }}
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deployment-successful:
    needs:
      [
        runner,
        create-deployment,
        deploy-vpc,
        deploy-graph,
        deploy-valkey,
        deploy-postgres,
        deploy-s3,
        deploy-grafana,
        deploy-prometheus,
        deploy-bastion,
        deploy-api,
        deploy-dagster,
        graph-container-refresh,
      ]
    if: |
      always() &&
      needs.runner.result == 'success' &&
      needs.create-deployment.result == 'success' &&
      needs.deploy-vpc.result == 'success' &&
      needs.deploy-graph.result == 'success' &&
      needs.deploy-valkey.result == 'success' &&
      needs.deploy-postgres.result == 'success' &&
      needs.deploy-s3.result == 'success' &&
      (needs.deploy-grafana.result == 'success' || needs.deploy-grafana.result == 'skipped') &&
      (needs.deploy-prometheus.result == 'success' || needs.deploy-prometheus.result == 'skipped') &&
      needs.deploy-bastion.result == 'success' &&
      needs.deploy-api.result == 'success' &&
      needs.deploy-dagster.result == 'success' &&
      (needs.graph-container-refresh.result == 'success' || needs.graph-container-refresh.result == 'skipped')
    runs-on: ${{ fromJSON(needs.runner.outputs.runner_config) }}
    outputs:
      deployment_id: ${{ needs.create-deployment.outputs.deployment_id }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}
          state: success
          deployment-id: ${{ needs.create-deployment.outputs.deployment_id }}
          description: "Production Deployment Succeeded"

  handle-deployment-failure:
    needs:
      [
        runner,
        create-deployment,
        deploy-vpc,
        deploy-graph,
        deploy-valkey,
        deploy-postgres,
        deploy-s3,
        deploy-grafana,
        deploy-prometheus,
        deploy-bastion,
        deploy-api,
        deploy-dagster,
      ]
    if: always() && contains(needs.*.result, 'failure')
    runs-on: ${{ fromJSON(needs.runner.outputs.runner_config) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Handle Deployment Failure
        uses: ./.github/actions/handle-deployment-failure
        with:
          deployment-id: ${{ needs.create-deployment.outputs.deployment_id }}
          environment: production
          github-token: ${{ secrets.ACTIONS_TOKEN }}
